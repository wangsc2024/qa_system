import sqlite3
import logging
import os
import codecs

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def import_departments():
    try:
        # 連接到 SQLite 資料庫
        conn = sqlite3.connect('database.db')
        cursor = conn.cursor()
        
        # 確保表存在
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS departments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            code TEXT UNIQUE NOT NULL,
            name TEXT NOT NULL
        )
        ''')
        conn.commit()
        
        # 手動插入部門資料 (從附件中提取的數據)
        departments_data = [
            ("0200", "民政處"),
            ("0210", "自治行政科"),
            ("0220", "宗教禮俗科"),
            ("0230", "戶政科"),
            ("0240", "役政科"),
            ("0250", "殯葬管理科"),
            ("0930", "法制科"),
            ("0400", "城鄉發展處"),
            ("0410", "工商科"),
            ("0420", "都市計畫科"),
            ("0430", "建築管理科"),
            ("0450", "城鄉規劃科"),
            ("0480", "公安使用科"),
            ("0470", "農村再生專案推動辦公室"),
            ("0500", "教育處"),
            ("0508", "督學室"),
            ("0510", "學務管理科"),
            ("0520", "國民教育科"),
            ("05A0", "終身教育科"),
            ("05D0", "學前教育科"),
            ("0005", "特殊教育科"),
            ("05F0", "教學發展科"),
            ("05G0", "特殊及學前教育科"),
            ("05H0", "學生事務科"),
            ("0600", "農業處"),
            ("0610", "農業企劃科"),
            ("0620", "林業及保育科"),
            ("0630", "畜產科"),
            ("0650", "農會輔導科"),
            ("0670", "農業產銷科"),
            ("0680", "動物保護及保育科"),
            ("0700", "社會處"),
            ("0710", "社會行政科"),
            ("0720", "社會工作科"),
            ("0730", "婦幼科"),
            ("0740", "社會救助科"),
            ("0750", "長青科"),
            ("0760", "身心障礙福利科"),
            ("0800", "地政處"),
            ("0810", "地價科"),
            ("0820", "地籍科"),
            ("0830", "地權科"),
            ("0840", "地用科"),
            ("0850", "重劃科"),
            ("0860", "地籍測量科"),
            ("0870", "地價及用地科"),
            ("0880", "國土規劃科"),
            ("0890", "國土管制科"),
            ("1000", "行政暨研考處"),
            ("0910", "文書檔案科"),
            ("0920", "庶務科"),
            ("0940", "採購品管科"),
            ("1010", "研究發展科"),
            ("1020", "管制考核科"),
            ("1030", "資訊管理科"),
            ("1050", "為民服務科"),
            ("1060", "數位發展中心"),
            ("1400", "工務處"),
            ("1410", "土木科"),
            ("1420", "養護科"),
            ("1430", "營建工程科"),
            ("1440", "公園管理科"),
            ("1500", "原住民處"),
            ("1510", "經建科"),
            ("1520", "產業發展科"),
            ("1530", "輔導行政科"),
            ("2200", "傳播暨國際事務處"),
            ("2210", "新聞行政科"),
            ("2220", "行銷企劃科"),
            ("2230", "國際事務科"),
            ("2240", "燈會專案辦公室"),
            ("2250", "多媒體事務科"),
            ("1600", "客家事務處"),
            ("1610", "產業輔導科"),
            ("1620", "民俗藝術科"),
            ("1630", "文化保存科"),
            ("1100", "人事處"),
            ("1110", "任免科"),
            ("1120", "考訓科"),
            ("1130", "給與科"),
            ("1140", "企劃科"),
            ("1200", "主計處"),
            ("1210", "歲計科"),
            ("1220", "單位會計科"),
            ("1230", "總會計科"),
            ("1240", "統計科"),
            ("1250", "基金科"),
            ("1300", "政風處"),
            ("1310", "政風預防科"),
            ("1320", "政風查處科"),
            ("1330", "政風行政科"),
            ("1340", "採購稽核小組"),
            ("1350", "政風稽核科"),
            ("1700", "文化處"),
            ("1710", "圖書資訊科"),
            ("1720", "博物美術科"),
            ("1740", "藝文推廣科"),
            ("1750", "表演藝術科"),
            ("1760", "文化設施經營科"),
            ("1800", "勞動暨青年發展處"),
            ("1810", "勞工行政科"),
            ("1820", "勞資關係科"),
            ("1830", "勞工福利科"),
            ("1840", "青年事務科"),
            ("1900", "水利處"),
            ("1910", "水利工程科"),
            ("1920", "水利行政科"),
            ("1930", "下水道科"),
            ("1940", "水土保持科"),
            ("2100", "交通旅遊處"),
            ("2110", "綜合規劃科"),
            ("2120", "運輸管理科"),
            ("2130", "設施工程科"),
            ("2140", "觀光管理科"),
            ("2150", "觀光推廣科"),
            ("2300", "長期照護處"),
            ("2310", "機構管理科"),
            ("2320", "服務管理科"),
            ("2330", "照顧管理科"),
            ("3110", "工程施工查核小組"),
            ("3200", "消保官室"),
            ("0000", "採購稽核小組(採)"),
            ("0103", "核稿/參議辦公室"),
            ("0102", "秘書長室"),
            ("0101", "副縣長室"),
            ("0100", "縣長室"),
        ]
        
        # 插入部門資料
        for code, name in departments_data:
            try:
                cursor.execute(
                    "INSERT INTO departments (code, name) VALUES (?, ?)",
                    (code, name)
                )
                logger.info(f"匯入部門: {code} - {name}")
            except sqlite3.IntegrityError:
                logger.warning(f"部門代碼 {code} 已存在，跳過")
        
        # 提交更改
        conn.commit()
        logger.info(f"共匯入 {len(departments_data)} 筆部門資料")
        
        # 更新部門代碼，確保處級部門為4位數，以00結尾
        cursor.execute("SELECT id, code, name FROM departments")
        departments = cursor.fetchall()
        
        # 更新處級部門代碼
        processed_codes = set()
        for dept_id, code, name in departments:
            # 處理非以00結尾且含「科」的部門
            if not code.endswith("00") and ("科" in name or "室" in name or "小組" in name):
                # 如果是科級單位，處理為所屬處
                bureau_code = code[:2] + "00"
                
                # 檢查是否有重複的處級部門代碼
                if bureau_code in processed_codes:
                    logger.info(f"刪除重複部門: {code} - {name}")
                    cursor.execute("DELETE FROM departments WHERE id = ?", (dept_id,))
                else:
                    # 更新為處級部門(保留原名)
                    cursor.execute("UPDATE departments SET code = ? WHERE id = ?", (bureau_code, dept_id))
                    processed_codes.add(bureau_code)
                    logger.info(f"更新科級單位為處級: {code} -> {bureau_code} ({name})")
        
        # 提交更改
        conn.commit()
        logger.info("部門代碼更新完成")
        
    except Exception as e:
        logger.error(f"匯入失敗: {str(e)}")
        if conn:
            conn.rollback()
    finally:
        if conn:
            conn.close()

if __name__ == "__main__":
    import_departments() 